namespace async_new_ops_test

use beagle.async as async
use beagle.effect as effect

// Test new async operations: is-directory?, is-file?, rename-file, copy-file

fn main() {
    println("=== Async New Operations Test ===")

    let handler = async/BlockingHandler {}

    let result = handle effect/Handler(async/Async) with handler {
        // Create test file
        println("Creating test file...")
        let write-result = async/write-file("/tmp/beagle_new_ops_test.txt", "Test content\n")
        match write-result {
            async/AsyncResult.Ok { value } => println("write-file: OK"),
            async/AsyncResult.Err { code, message } => println("write-file error:", message)
        }

        // Test is-file?
        println("Testing is-file?...")
        let is-file-result = async/is-file?("/tmp/beagle_new_ops_test.txt")
        match is-file-result {
            async/AsyncResult.Ok { value } => {
                if value {
                    println("is-file?: true (correct)")
                } else {
                    println("is-file?: false (WRONG)")
                }
            },
            async/AsyncResult.Err { code, message } => println("is-file? error:", message)
        }

        // Test is-directory? on file (should be false)
        println("Testing is-directory? on file...")
        let is-dir-result = async/is-directory?("/tmp/beagle_new_ops_test.txt")
        match is-dir-result {
            async/AsyncResult.Ok { value } => {
                if value {
                    println("is-directory?: true (WRONG)")
                } else {
                    println("is-directory?: false (correct)")
                }
            },
            async/AsyncResult.Err { code, message } => println("is-directory? error:", message)
        }

        // Test is-directory? on /tmp (should be true)
        println("Testing is-directory? on /tmp...")
        let is-dir-result2 = async/is-directory?("/tmp")
        match is-dir-result2 {
            async/AsyncResult.Ok { value } => {
                if value {
                    println("is-directory? /tmp: true (correct)")
                } else {
                    println("is-directory? /tmp: false (WRONG)")
                }
            },
            async/AsyncResult.Err { code, message } => println("is-directory? /tmp error:", message)
        }

        // Test copy-file
        println("Testing copy-file...")
        let copy-result = async/copy-file("/tmp/beagle_new_ops_test.txt", "/tmp/beagle_new_ops_copy.txt")
        match copy-result {
            async/AsyncResult.Ok { value } => println("copy-file: OK"),
            async/AsyncResult.Err { code, message } => println("copy-file error:", message)
        }

        // Verify copy exists
        println("Verifying copy exists...")
        let exists-result = async/file-exists?("/tmp/beagle_new_ops_copy.txt")
        match exists-result {
            async/AsyncResult.Ok { value } => {
                if value {
                    println("Copy exists: OK")
                } else {
                    println("Copy exists: FAIL")
                }
            },
            async/AsyncResult.Err { code, message } => println("file-exists? error:", message)
        }

        // Test rename-file
        println("Testing rename-file...")
        let rename-result = async/rename-file("/tmp/beagle_new_ops_copy.txt", "/tmp/beagle_new_ops_renamed.txt")
        match rename-result {
            async/AsyncResult.Ok { value } => println("rename-file: OK"),
            async/AsyncResult.Err { code, message } => println("rename-file error:", message)
        }

        // Verify rename worked
        println("Verifying rename worked...")
        let old-exists = async/file-exists?("/tmp/beagle_new_ops_copy.txt")
        let new-exists = async/file-exists?("/tmp/beagle_new_ops_renamed.txt")
        match old-exists {
            async/AsyncResult.Ok { value } => {
                if value {
                    println("Old file still exists: FAIL")
                } else {
                    println("Old file gone: OK")
                }
            },
            async/AsyncResult.Err { code, message } => println("file-exists? error:", message)
        }
        match new-exists {
            async/AsyncResult.Ok { value } => {
                if value {
                    println("New file exists: OK")
                } else {
                    println("New file missing: FAIL")
                }
            },
            async/AsyncResult.Err { code, message } => println("file-exists? error:", message)
        }

        // Cleanup
        println("Cleaning up...")
        async/delete-file("/tmp/beagle_new_ops_test.txt")
        async/delete-file("/tmp/beagle_new_ops_renamed.txt")

        println("=== All tests completed ===")
        42
    }

    println("Result:", result)
}

// Expect
// === Async New Operations Test ===
// Creating test file...
// write-file: OK
// Testing is-file?...
// is-file?: true (correct)
// Testing is-directory? on file...
// is-directory?: false (correct)
// Testing is-directory? on /tmp...
// is-directory? /tmp: true (correct)
// Testing copy-file...
// copy-file: OK
// Verifying copy exists...
// Copy exists: OK
// Testing rename-file...
// rename-file: OK
// Verifying rename worked...
// Old file gone: OK
// New file exists: OK
// Cleaning up...
// === All tests completed ===
// Result: 42
