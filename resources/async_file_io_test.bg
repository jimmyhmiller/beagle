namespace async_file_io_test

use beagle.async as async
use beagle.effect as effect

// Test async file I/O using the EventLoopHandler

fn main() {
    // Create an event loop handler
    let handler = async/create-event-loop-handler(4)  // 4 worker threads

    // Test 1: Write and read a file
    handle effect/Handler(async/Async) with handler {
        let test_path = "/tmp/beagle_async_test.txt"
        let content = "Hello from async file I/O!"

        // Write file
        println("Writing file...")
        let write_result = async/write-file(test_path, content)
        match write_result {
            async/AsyncResult.Ok { value } => {
                println("Write OK, bytes: ", value)
            },
            async/AsyncResult.Err { code, message } => {
                println("Write ERROR: ", message)
            }
        }

        // Read file
        println("Reading file...")
        let read_result = async/read-file(test_path)
        match read_result {
            async/AsyncResult.Ok { value } => {
                println("Read OK: ", value)
            },
            async/AsyncResult.Err { code, message } => {
                println("Read ERROR: ", message)
            }
        }

        // Get file size
        println("Getting file size...")
        let size_result = async/file-size(test_path)
        match size_result {
            async/AsyncResult.Ok { value } => {
                println("Size: ", value)
            },
            async/AsyncResult.Err { code, message } => {
                println("Size ERROR: ", message)
            }
        }

        // Delete file
        println("Deleting file...")
        let delete_result = async/delete-file(test_path)
        match delete_result {
            async/AsyncResult.Ok { value } => {
                println("Delete OK")
            },
            async/AsyncResult.Err { code, message } => {
                println("Delete ERROR: ", message)
            }
        }

        println("Done!")
    }

    "done"
}

// Expect
// Writing file...
// Write OK, bytes:  26
// Reading file...
// Read OK:  Hello from async file I/O!
// Getting file size...
// Size:  26
// Deleting file...
// Delete OK
// Done!
