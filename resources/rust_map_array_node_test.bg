namespace rust-map-array-node-test
use beagle.collections as rmap

// Test that builds a map with 20+ entries at the root level
// This should trigger promotion from BitmapNode to ArrayNode

fn build-large-map(n, m) {
    if n <= 0 {
        m
    } else {
        let m2 = rmap/map-assoc(m, n, n * 10)
        build-large-map(n - 1, m2)
    }
}

fn verify-large-map(n, m) {
    if n <= 0 {
        true
    } else {
        let v = rmap/map-get(m, n)
        if v == n * 10 {
            verify-large-map(n - 1, m)
        } else {
            println("FAILED: key")
            println(n)
            println("expected")
            println(n * 10)
            println("got")
            println(v)
            false
        }
    }
}

fn main() {
    // Build map with 25 integer keys (should trigger ArrayNode promotion at 16)
    let m = build-large-map(25, rmap/map())
    println(rmap/map-count(m))

    // Verify all keys
    if verify-large-map(25, m) {
        println("all keys verified")
    } else {
        println("verification failed")
    }

    // Test specific lookups
    println(rmap/map-get(m, 1))
    println(rmap/map-get(m, 15))
    println(rmap/map-get(m, 25))

    // Update a key and verify
    let m2 = rmap/map-assoc(m, 10, 999)
    println(rmap/map-get(m2, 10))
    println(rmap/map-get(m, 10))

    // GC test
    gc()
    println(rmap/map-get(m, 20))
    println(rmap/map-get(m2, 5))

    println("done")
}

// Expect
// 25
// all keys verified
// 10
// 150
// 250
// 999
// 100
// 200
// 50
// done
