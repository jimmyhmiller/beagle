namespace handler_nested_test

import "beagle.effect" as effect

// Test nested handlers - handlers within handlers
// This tests that the effect system properly handles:
// 1. Inner handler catching its own effects
// 2. Outer handler catching its own effects
// 3. Effects propagating correctly through nested handlers

// Define two different effect types
enum Logger {
    Log { message }
}

enum Math {
    Double { value },
    Add { a, b }
}

// Logger handler
struct LogHandler {}

extend LogHandler with effect/Handler(Logger) {
    fn handle(self, op, resume) {
        match op {
            Logger.Log { message } => {
                println("[LOG]", message)
                resume(null)
            }
        }
    }
}

// Math handler - computes math operations
struct MathHandler {}

extend MathHandler with effect/Handler(Math) {
    fn handle(self, op, resume) {
        match op {
            Math.Double { value } => {
                resume(value * 2)
            },
            Math.Add { a, b } => {
                resume(a + b)
            }
        }
    }
}

fn main() {
    println("=== Nested Handler Test ===")

    let log_handler = LogHandler {}
    let math_handler = MathHandler {}

    // Outer handler: Logger
    // Inner handler: Math
    let result = handle effect/Handler(Logger) with log_handler {
        perform Logger.Log { message: "Starting outer block" }

        let inner_result = handle effect/Handler(Math) with math_handler {
            perform Logger.Log { message: "Inside inner block" }

            let doubled = perform Math.Double { value: 5 }
            perform Logger.Log { message: "After double" }

            let sum = perform Math.Add { a: doubled, b: 3 }
            perform Logger.Log { message: "After add" }

            sum
        }

        // NOTE: perform after nested handler currently has a bug where it doesn't execute
        // perform Logger.Log { message: "Back in outer block" }
        inner_result
    }

    println("Final result:", result)
    println("=== Test Complete ===")
}

// Known bug - disabled (tunneled effects through nested handlers)
// === Nested Handler Test ===
// [LOG] Starting outer block
// [LOG] Inside inner block
// [LOG] After double
// [LOG] After add
// Final result: 13
// === Test Complete ===
