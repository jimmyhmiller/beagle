namespace stdlib_collections_test

// Helper: modulo operation (a mod b)
fn mod(a, b) {
    a - (a / b) * b
}

// Helper: check if even
fn even?(n) {
    mod(n, 2) == 0
}

fn main() {
    // Test map
    let doubled = map([1, 2, 3], fn(x) { x * 2 })
    println("map:", doubled)

    // Test filter
    let evens = filter([1, 2, 3, 4, 5], fn(x) { even?(x) })
    println("filter:", evens)

    // Test reduce
    let sum = reduce([1, 2, 3, 4], 0, fn(acc, x) { acc + x })
    println("reduce:", sum)

    // Test any?
    let has-even = any?([1, 3, 4, 5], fn(x) { even?(x) })
    println("any?:", has-even)

    // Test all?
    let all-positive = all?([1, 2, 3], fn(x) { x > 0 })
    println("all?:", all-positive)

    // Test none?
    let no-negatives = none?([1, 2, 3], fn(x) { x < 0 })
    println("none?:", no-negatives)

    // Test find
    let found = find([1, 2, 3, 4], fn(x) { x > 2 })
    println("find:", found)

    // Test find-index
    let idx = find-index([1, 2, 3, 4], fn(x) { x > 2 })
    println("find-index:", idx)

    // Test take
    let first-two = take([1, 2, 3, 4], 2)
    println("take:", first-two)

    // Test drop
    let after-two = drop([1, 2, 3, 4], 2)
    println("drop:", after-two)

    // Test take-while
    let while-small = take-while([1, 2, 3, 4, 1], fn(x) { x < 3 })
    println("take-while:", while-small)

    // Test drop-while
    let after-small = drop-while([1, 2, 3, 4, 1], fn(x) { x < 3 })
    println("drop-while:", after-small)

    // Test slice
    let middle = slice([1, 2, 3, 4, 5], 1, 4)
    println("slice:", middle)

    // Test count/empty?
    println("count:", count([1, 2, 3]))
    let empty-result = empty?([])
    println("empty?", empty-result)
    println("empty? non-empty:", empty?([1]))

    // Test last
    println("last:", last([1, 2, 3]))

    // Test rest
    println("rest:", rest([1, 2, 3]))

    // Test butlast
    println("butlast:", butlast([1, 2, 3]))

    // Test concat
    println("concat:", concat([1, 2], [3, 4]))

    // Test flatten
    println("flatten:", flatten([[1, 2], [3, 4]]))

    // Test flat-map
    println("flat-map:", flat-map([1, 2], fn(x) { [x, x * 10] }))

    // Test zip
    println("zip:", zip([1, 2, 3], ["a", "b", "c"]))

    // Test zip-with
    println("zip-with:", zip-with([1, 2, 3], [10, 20, 30], fn(a, b) { a + b }))

    // Test interleave
    println("interleave:", interleave([1, 2, 3], ["a", "b", "c"]))

    // Test interpose
    println("interpose:", interpose([1, 2, 3], 0))

    // Test reverse
    println("reverse:", reverse([1, 2, 3]))

    // Test repeat
    println("repeat:", repeat("x", 3))

    // Test repeatedly
    let counter = atom(0)
    let incremented = repeatedly(fn() {
        swap!(counter, fn(x) { x + 1 })
    }, 3)
    println("repeatedly:", incremented)

    // Test iterate
    println("iterate:", iterate(fn(x) { x * 2 }, 1, 5))

    // Test partition
    println("partition:", partition([1, 2, 3, 4, 5, 6], 2))

    // Test group-by
    println("group-by:", group-by([1, 2, 3, 4, 5, 6], fn(x) { mod(x, 2) }))

    // Test frequencies
    println("frequencies:", frequencies([1, 1, 2, 2, 2, 3]))

    // Test distinct
    println("distinct:", distinct([1, 2, 2, 3, 1, 4]))

    // Test sort
    println("sort:", sort([3, 1, 4, 1, 5, 9, 2, 6]))

    // Test sort-by
    println("sort-by:", sort-by(["bb", "a", "ccc"], fn(s) { length(s) }))

    // Test identity
    let id-result = identity(42)
    println("identity", id-result)

    // Test complement
    let is-not-even = complement(fn(x) { mod(x, 2) == 0 })
    println("complement:", is-not-even(3))

    // Test compose
    let double = fn(x) { x * 2 }
    let add-one = fn(x) { x + 1 }
    let double-then-add = compose(add-one, double)
    println("compose:", double-then-add(5))

    // Test partial
    let add = fn(a, b) { a + b }
    let add5 = partial(add, 5)
    println("partial:", add5(10))

    // Test not/truthy?/falsy?
    println("not:", not(true))
    println("truthy?:", truthy?(1))
    println("falsy?:", falsy?(null))

    // Test nil?/some?
    let nil-result = nil?(null)
    println("nil?", nil-result)
    let some-result = some?(42)
    println("some?", some-result)

    "done"
}

// Expect
// map: [2, 4, 6]
// filter: [2, 4]
// reduce: 10
// any?: true
// all?: true
// none?: true
// find: 3
// find-index: 2
// take: [1, 2]
// drop: [3, 4]
// take-while: [1, 2]
// drop-while: [3, 4, 1]
// slice: [2, 3, 4]
// count: 3
// empty? true
// empty? non-empty: false
// last: 3
// rest: [2, 3]
// butlast: [1, 2]
// concat: [1, 2, 3, 4]
// flatten: [1, 2, 3, 4]
// flat-map: [1, 10, 2, 20]
// zip: [[1, "a"], [2, "b"], [3, "c"]]
// zip-with: [11, 22, 33]
// interleave: [1, "a", 2, "b", 3, "c"]
// interpose: [1, 0, 2, 0, 3]
// reverse: [3, 2, 1]
// repeat: ["x", "x", "x"]
// repeatedly: [1, 2, 3]
// iterate: [1, 2, 4, 8, 16]
// partition: [[1, 2], [3, 4], [5, 6]]
// group-by: {0 [2, 4, 6], 1 [1, 3, 5]}
// frequencies: {2 3, 1 2, 3 1}
// distinct: [1, 2, 3, 4]
// sort: [1, 1, 2, 3, 4, 5, 6, 9]
// sort-by: ["a", "bb", "ccc"]
// identity 42
// complement: true
// compose: 11
// partial: 15
// not: false
// truthy?: true
// falsy?: true
// nil? true
// some? true

