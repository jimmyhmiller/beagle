namespace continuation_gc_stress_test

import "beagle.effect" as effect

struct Node { value, next }

enum Probe {
    Capture { heap_obj }
}

struct ProbeHandler {}

extend ProbeHandler with effect/Handler(Probe) {
    fn handle(self, op, resume) {
        match op {
            Probe.Capture { heap_obj } => {
                // Force GC - allocate many objects
                let mut i = 0
                loop {
                    if i >= 1000 {
                        break(null)
                    }
                    let _ = Node { value: i, next: null }
                    i = i + 1
                }

                // Resume - if heap_obj was collected, this crashes
                resume(heap_obj)
            }
        }
    }
}

fn main() {
    println("Creating heap object in continuation...")

    let handler = ProbeHandler {}
    let result = handle effect/Handler(Probe) with handler {
        let live_obj = Node {
            value: 42,
            next: Node { value: 99, next: null }
        }

        let recovered = perform Probe.Capture { heap_obj: live_obj }

        println("Recovered value:", recovered.value)
        println("Recovered next:", recovered.next.value)

        recovered.value + recovered.next.value
    }

    println("Final result:", result)
    println("Success!")
}

// Expect
// Creating heap object in continuation...
// Recovered value: 42
// Recovered next: 99
// Final result: 141
// Success!
