namespace async_parallel_test

use beagle.async as async
use beagle.effect as effect
use beagle.core as core

// Test that ThreadedAsyncHandler spawns actual threads
// This test verifies that futures run on different threads by checking thread IDs.
// This proves the threading infrastructure works without relying on timing.

fn main() {
    println("=== Async Parallel Execution Test ===")

    let handler = async/ThreadedAsyncHandler {}
    let main_thread_id = core/thread-id()

    let result = handle effect/Handler(async/Async) with handler {
        println("Main thread ID:", main_thread_id)

        // Spawn two futures that capture their thread ID
        let f1 = async/async(fn() {
            let id = core/thread-id()
            // Small sleep to ensure thread is actually used
            core/sleep(10)
            id
        })

        let f2 = async/async(fn() {
            let id = core/thread-id()
            core/sleep(10)
            id
        })

        // Wait for both
        let thread_id_1 = async/await(f1)
        let thread_id_2 = async/await(f2)

        println("Future 1 thread ID:", thread_id_1)
        println("Future 2 thread ID:", thread_id_2)

        // Verify futures ran on different threads than main
        let f1_different = thread_id_1 != main_thread_id
        let f2_different = thread_id_2 != main_thread_id

        if f1_different && f2_different {
            println("Threads spawned: OK")
        } else {
            println("Threads spawned: FAILED (futures ran on main thread)")
        }

        "done"
    }

    println("Final result:", result)
}

// Expect
// === Async Parallel Execution Test ===
// Main thread ID: 1
// Future 1 thread ID: 2
// Future 2 thread ID: 3
// Threads spawned: OK
// Final result: done
