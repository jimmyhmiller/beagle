namespace hash_table_test

import "beagle.builtin" as builtin
import "raw_mutable_array" as arr

let HT_KEYS = 0
let HT_COUNTS = 1
let HT_SIZE = 2
let HT_CAPACITY = 3

fn new_hash_table(capacity) {
    let ht = arr/new_array(4)
    arr/write_field(ht, HT_KEYS, arr/new_array(capacity))
    arr/write_field(ht, HT_COUNTS, arr/new_array(capacity))
    arr/write_field(ht, HT_SIZE, 0)
    arr/write_field(ht, HT_CAPACITY, capacity)
    ht
}

fn hash_string(s, capacity) {
    let h = builtin/hash(s)
    let h2 = if h < 0 { 0 - h } else { h }
    h2 - (h2 / capacity) * capacity
}

fn ht_increment(ht, key) {
    let keys = arr/read_field(ht, HT_KEYS)
    let counts = arr/read_field(ht, HT_COUNTS)
    let capacity = arr/read_field(ht, HT_CAPACITY)
    let idx = hash_string(key, capacity)
    ht_probe_and_increment(ht, keys, counts, capacity, key, idx, 0)
}

fn ht_probe_and_increment(ht, keys, counts, capacity, key, idx, probes) {
    if probes >= capacity {
        null
    } else {
        let existing_key = arr/read_field(keys, idx)
        if existing_key == null {
            arr/write_field(keys, idx, key)
            arr/write_field(counts, idx, 1)
            let size = arr/read_field(ht, HT_SIZE)
            arr/write_field(ht, HT_SIZE, size + 1)
            null
        } else {
            if existing_key == key {
                let count = arr/read_field(counts, idx)
                arr/write_field(counts, idx, count + 1)
                null
            } else {
                let next_idx = idx + 1
                let wrapped_idx = if next_idx >= capacity { 0 } else { next_idx }
                ht_probe_and_increment(ht, keys, counts, capacity, key, wrapped_idx, probes + 1)
            }
        }
    }
}

fn main() {
    let seq = "ACGTACGT"
    let ht = new_hash_table(16)

    // Insert all 1-mers
    println("Inserting 1-mers from ACGTACGT...")
    let mut i = 0
    while i < 8 {
        let kmer = substring(seq, i, 1)
        println(kmer)
        ht_increment(ht, kmer)
        i = i + 1
    }

    let size = arr/read_field(ht, HT_SIZE)
    println("Hash table size (should be 4):")
    println(size)

    ""
}

// Expect
// Inserting 1-mers from ACGTACGT...
// A
// C
// G
// T
// A
// C
// G
// T
// Hash table size (should be 4):
// 4
